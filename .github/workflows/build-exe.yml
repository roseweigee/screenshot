name: Build Windows EXE (Chrome 129 Compatible)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium>=4.15.0 pillow pyinstaller
    
    - name: Download ChromeDriver 129
      run: |
        # æŒ‡å®šä¸‹è¼‰ ChromeDriver 129.0.6668.90 ç‰ˆæœ¬
        $version = "129.0.6668.90"
        $url = "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$version/win64/chromedriver-win64.zip"
        
        Write-Host "ä¸‹è¼‰ ChromeDriver ç‰ˆæœ¬: $version"
        Write-Host "ä¸‹è¼‰ URL: $url"
        
        try {
          Invoke-WebRequest -Uri $url -OutFile "chromedriver.zip"
          Expand-Archive -Path "chromedriver.zip" -DestinationPath "temp"
          
          # ç§»å‹•æª”æ¡ˆåˆ°æ­£ç¢ºä½ç½®
          Copy-Item "temp/chromedriver-win64/chromedriver.exe" -Destination "chromedriver.exe"
          Remove-Item "chromedriver.zip"
          Remove-Item "temp" -Recurse
          
          # é©—è­‰ä¸‹è¼‰çš„æª”æ¡ˆ
          if (Test-Path "chromedriver.exe") {
            Write-Host "âœ… ChromeDriver 129 ä¸‹è¼‰æˆåŠŸ"
            & .\chromedriver.exe --version
          } else {
            Write-Host "âŒ ChromeDriver ä¸‹è¼‰å¤±æ•—"
            exit 1
          }
        } catch {
          Write-Host "âŒ ä¸‹è¼‰ ChromeDriver 129 å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ..."
          
          # å‚™ç”¨æ–¹æ¡ˆï¼šå¾ GitHub é¡åƒä¸‹è¼‰
          try {
            $backupUrl = "https://github.com/electron/electron/releases/download/v25.0.0/chromedriver-v129.0.6668.90-win32-x64.zip"
            Invoke-WebRequest -Uri $backupUrl -OutFile "chromedriver_backup.zip"
            Expand-Archive -Path "chromedriver_backup.zip" -DestinationPath "."
            Remove-Item "chromedriver_backup.zip"
            Write-Host "âœ… å¾å‚™ç”¨ä¾†æºä¸‹è¼‰ ChromeDriver æˆåŠŸ"
          } catch {
            Write-Host "âŒ æ‰€æœ‰ä¸‹è¼‰æ–¹æ¡ˆéƒ½å¤±æ•—"
            Write-Host "è«‹æ‰‹å‹•ä¸‹è¼‰ ChromeDriver 129 ä¸¦æ”¾å…¥å°ˆæ¡ˆæ ¹ç›®éŒ„"
            exit 1
          }
        }
    
    - name: Create requirements.txt (if not exists)
      run: |
        if (-not (Test-Path "requirements.txt")) {
          Write-Host "å»ºç«‹ requirements.txt æª”æ¡ˆ"
          @"
        selenium>=4.15.0
        pillow>=9.0.0
        "@ | Out-File -FilePath "requirements.txt" -Encoding utf8
        } else {
          Write-Host "requirements.txt å·²å­˜åœ¨"
          Get-Content requirements.txt
        }
    
    - name: Verify Python environment
      run: |
        python --version
        pip list | findstr selenium
        pip list | findstr pillow
    
    - name: Build executable
      run: |
        # è¨­å®šæ§åˆ¶å°ç·¨ç¢¼ç‚º UTF-8
        $env:PYTHONIOENCODING = "utf-8"
        chcp 65001
        
        # ç¢ºèªæª”æ¡ˆå­˜åœ¨
        if (-not (Test-Path "screenshot_app.py")) {
          Write-Host "âŒ screenshot_app.py æª”æ¡ˆä¸å­˜åœ¨"
          exit 1
        }
        
        if (-not (Test-Path "chromedriver.exe")) {
          Write-Host "âŒ chromedriver.exe æª”æ¡ˆä¸å­˜åœ¨"
          exit 1
        }
        
        Write-Host "ğŸ“¦ é–‹å§‹å»ºç«‹ EXE æª”æ¡ˆ..."
        
        # åˆ†æ®µåŸ·è¡Œ PyInstaller å‘½ä»¤ä»¥é¿å…æˆªæ–·
        $pyinstallerArgs = @(
          "--onefile",
          "--console",
          "--name=WebScreenshot",
          "--add-data=chromedriver.exe;.",
          "--distpath=dist",
          "--workpath=build",
          "--specpath=.",
          "--hidden-import=encodings",
          "--hidden-import=encodings.utf_8",
          "screenshot_app.py"
        )
        
        pyinstaller @pyinstallerArgs
        
        # é©—è­‰å»ºç«‹çš„ EXE
        if (Test-Path "dist/WebScreenshot.exe") {
          Write-Host "âœ… EXE å»ºç«‹æˆåŠŸ"
          $fileSize = (Get-Item "dist/WebScreenshot.exe").Length / 1MB
          Write-Host "æª”æ¡ˆå¤§å°: $($fileSize.ToString('F2')) MB"
        } else {
          Write-Host "âŒ EXE å»ºç«‹å¤±æ•—"
          exit 1
        }
    
    - name: Test executable (optional)
      run: |
        # ç°¡å–®æ¸¬è©¦ï¼šæª¢æŸ¥ EXE æ˜¯å¦èƒ½é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
        try {
          & .\dist\WebScreenshot.exe --help
          Write-Host "âœ… EXE åŸºæœ¬åŠŸèƒ½æ¸¬è©¦é€šé"
        } catch {
          Write-Host "âš ï¸  EXE æ¸¬è©¦å¤±æ•—ï¼Œä½†é€™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼ˆæ²’æœ‰é¡¯ç¤ºç’°å¢ƒï¼‰"
        }
    
    - name: Create offline package
      run: |
        # å»ºç«‹é›¢ç·šå®‰è£åŒ…
        New-Item -ItemType Directory -Path "offline_package" -Force
        
        # è¤‡è£½ EXE å’Œ ChromeDriver
        Copy-Item "dist/WebScreenshot.exe" -Destination "offline_package/"
        Copy-Item "chromedriver.exe" -Destination "offline_package/"
        
        # å»ºç«‹ä½¿ç”¨èªªæ˜
        @"
        # WebScreenshot é›¢ç·šç‰ˆ v2.0.0
        
        ## ç³»çµ±éœ€æ±‚
        - Windows 10/11
        - Chrome ç€è¦½å™¨ 129.x ç‰ˆæœ¬
        
        ## æª”æ¡ˆèªªæ˜
        - WebScreenshot.exe: ä¸»ç¨‹å¼
        - chromedriver.exe: Chrome é©…å‹•ç¨‹å¼ï¼ˆå·²å…§å»ºï¼‰
        
        ## ä½¿ç”¨æ–¹æ³•
        
        ### åŸºæœ¬ç”¨æ³•
        ```
        WebScreenshot.exe https://www.google.com
        ```
        
        ### æŒ‡å®šè¼¸å‡ºæª”æ¡ˆ
        ```
        WebScreenshot.exe https://www.example.com --output screenshot.png
        ```
        
        ### æ‰‹æ©Ÿç‰ˆè§£æåº¦
        ```
        WebScreenshot.exe https://www.apple.com --mobile --output mobile.png
        ```
        
        ### 4K é«˜è§£æåº¦
        ```
        WebScreenshot.exe https://www.site.com --uhd --output 4k.png
        ```
        
        ### è‡ªè¨‚è§£æåº¦
        ```
        WebScreenshot.exe https://www.site.com --width 1600 --height 900 --output custom.png
        ```
        
        ### åªæˆªå–å¯è¦–å€åŸŸ
        ```
        WebScreenshot.exe https://www.site.com --no-full-page --output viewport.png
        ```
        
        ### æ‰€æœ‰åƒæ•¸
        ```
        WebScreenshot.exe [URL] [é¸é …]
        
        é¸é …ï¼š
          -o, --output [æª”å]     è¼¸å‡ºæª”æ¡ˆåç¨±
          -w, --width [æ•¸å­—]      è¦–çª—å¯¬åº¦
          --height [æ•¸å­—]         è¦–çª—é«˜åº¦
          --mobile               æ‰‹æ©Ÿè§£æåº¦ (375x812)
          --tablet               å¹³æ¿è§£æåº¦ (768x1024)
          --hd                   HDè§£æåº¦ (1366x768)
          --fhd                  Full HDè§£æåº¦ (1920x1080)
          --qhd                  QHDè§£æåº¦ (2560x1440)
          --uhd                  4Kè§£æåº¦ (3840x2160)
          --no-full-page         åªæˆªå–å¯è¦–å€åŸŸ
          --wait [ç§’æ•¸]          é é¢è¼‰å…¥ç­‰å¾…æ™‚é–“
          --dpi [å€æ•¸]           DPIç¸®æ”¾å€æ•¸
          --quality [1-100]      JPEGå“è³ªï¼ˆåƒ…é©ç”¨æ–¼.jpg/.jpegï¼‰
          --help                 é¡¯ç¤ºèªªæ˜
          --version              é¡¯ç¤ºç‰ˆæœ¬
        ```
        
        ## æ³¨æ„äº‹é …
        
        1. **Chrome ç‰ˆæœ¬ç›¸å®¹æ€§**
           - æ­¤ç‰ˆæœ¬ç›¸å®¹ Chrome 129.x
           - å¦‚æœä½ çš„ Chrome ç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½æœƒå‡ºç¾ç›¸å®¹æ€§å•é¡Œ
           - å¯ä»¥åœ¨ Chrome è¨­å®š > é—œæ–¼ Chrome ä¸­æŸ¥çœ‹ç‰ˆæœ¬
        
        2. **é›¢ç·šä½¿ç”¨**
           - æ­¤ç¨‹å¼å¯åœ¨é›¢ç·šç’°å¢ƒä½¿ç”¨
           - ä½†è¦æˆªå–çš„ç¶²é å¿…é ˆæ˜¯å…§ç¶²æˆ–æœ¬åœ°å¯å­˜å–çš„
        
        3. **æª”æ¡ˆæ ¼å¼**
           - æ”¯æ´ PNGï¼ˆé è¨­ï¼‰å’Œ JPEG æ ¼å¼
           - PNG æ”¯æ´é€æ˜åº¦ï¼ŒJPEG æª”æ¡ˆè¼ƒå°
        
        4. **æ•ˆèƒ½è€ƒé‡**
           - 4K å’Œè¶…é«˜è§£æåº¦æˆªåœ–éœ€è¦è¼ƒå¤šè¨˜æ†¶é«”
           - è¤‡é›œé é¢å¯èƒ½éœ€è¦å¢åŠ ç­‰å¾…æ™‚é–“ï¼ˆ--wait åƒæ•¸ï¼‰
        
        ## å¸¸è¦‹å•é¡Œ
        
        **Q: å‡ºç¾ "ChromeDriver version mismatch" éŒ¯èª¤ï¼Ÿ**
        A: è¡¨ç¤ºä½ çš„ Chrome ç‰ˆæœ¬èˆ‡ ChromeDriver ä¸ç›¸å®¹ï¼Œè«‹æ›´æ–° Chrome åˆ° 129.x ç‰ˆæœ¬ã€‚
        
        **Q: æˆªåœ–æ˜¯ç©ºç™½çš„ï¼Ÿ**
        A: å¯èƒ½æ˜¯é é¢è¼‰å…¥æ™‚é–“ä¸è¶³ï¼Œå˜—è©¦å¢åŠ ç­‰å¾…æ™‚é–“ï¼š--wait 5
        
        **Q: ç„¡æ³•å­˜å–å…§ç¶²ç¶²ç«™ï¼Ÿ**
        A: ç¢ºèªç¶²è·¯é€£ç·šå’Œé˜²ç«ç‰†è¨­å®šï¼Œæˆ–å˜—è©¦ä½¿ç”¨ --no-full-page é¸é …ã€‚
        
        ## æŠ€è¡“æ”¯æ´
        
        å»ºç«‹æ™‚é–“: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
        Chrome ç‰ˆæœ¬: 129.x
        ChromeDriver ç‰ˆæœ¬: 129.0.6668.90
        Selenium ç‰ˆæœ¬: 4.15.0+
        
        "@  | Out-File -FilePath "offline_package/README.md" -Encoding utf8
        
        # å»ºç«‹æ‰¹æ¬¡æª”æ¡ˆç¯„ä¾‹
        @"
        @echo off
        chcp 65001 >nul
        echo === WebScreenshot å¿«é€Ÿä½¿ç”¨ ===
        echo.
        set /p url="è«‹è¼¸å…¥ç¶²å€: "
        if "%url%"=="" (
            echo éŒ¯èª¤ï¼šè«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€
            pause
            exit /b 1
        )
        
        set /p filename="è¼¸å‡ºæª”åï¼ˆç›´æ¥æŒ‰ Enter ä½¿ç”¨é è¨­ï¼‰: "
        if "%filename%"=="" set filename=screenshot.png
        
        echo.
        echo æ­£åœ¨æˆªåœ–...
        WebScreenshot.exe "%url%" --output "%filename%"
        
        if %errorlevel%==0 (
            echo.
            echo âœ… æˆªåœ–å®Œæˆ: %filename%
        ) else (
            echo.
            echo âŒ æˆªåœ–å¤±æ•—
        )
        
        pause
        "@ | Out-File -FilePath "offline_package/å¿«é€Ÿæˆªåœ–.bat" -Encoding utf8
        
        Write-Host "âœ… é›¢ç·šå®‰è£åŒ…å»ºç«‹å®Œæˆ"
    
    - name: Upload executable and offline package
      uses: actions/upload-artifact@v4
      with:
        name: WebScreenshot-Windows-EXE-Chrome129-Offline
        path: |
          offline_package/
        retention-days: 30
    
    - name: Upload individual files
      uses: actions/upload-artifact@v4
      with:
        name: WebScreenshot-Individual-Files
        path: |
          dist/WebScreenshot.exe
          chromedriver.exe
        retention-days: 30
