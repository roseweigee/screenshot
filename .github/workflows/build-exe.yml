name: Build Windows EXE (Chrome 129 Compatible)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium>=4.15.0 pillow pyinstaller
    
    - name: Download ChromeDriver 129
      run: |
        # 指定下載 ChromeDriver 129.0.6668.90 版本
        $version = "129.0.6668.90"
        $url = "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$version/win64/chromedriver-win64.zip"
        
        Write-Host "下載 ChromeDriver 版本: $version"
        Write-Host "下載 URL: $url"
        
        try {
          Invoke-WebRequest -Uri $url -OutFile "chromedriver.zip"
          Expand-Archive -Path "chromedriver.zip" -DestinationPath "temp"
          
          # 移動檔案到正確位置
          Copy-Item "temp/chromedriver-win64/chromedriver.exe" -Destination "chromedriver.exe"
          Remove-Item "chromedriver.zip"
          Remove-Item "temp" -Recurse
          
          # 驗證下載的檔案
          if (Test-Path "chromedriver.exe") {
            Write-Host "✅ ChromeDriver 129 下載成功"
            & .\chromedriver.exe --version
          } else {
            Write-Host "❌ ChromeDriver 下載失敗"
            exit 1
          }
        } catch {
          Write-Host "❌ 下載 ChromeDriver 129 失敗，嘗試備用方案..."
          
          # 備用方案：從 GitHub 鏡像下載
          try {
            $backupUrl = "https://github.com/electron/electron/releases/download/v25.0.0/chromedriver-v129.0.6668.90-win32-x64.zip"
            Invoke-WebRequest -Uri $backupUrl -OutFile "chromedriver_backup.zip"
            Expand-Archive -Path "chromedriver_backup.zip" -DestinationPath "."
            Remove-Item "chromedriver_backup.zip"
            Write-Host "✅ 從備用來源下載 ChromeDriver 成功"
          } catch {
            Write-Host "❌ 所有下載方案都失敗"
            Write-Host "請手動下載 ChromeDriver 129 並放入專案根目錄"
            exit 1
          }
        }
    
    - name: Create requirements.txt (if not exists)
      run: |
        if (-not (Test-Path "requirements.txt")) {
          Write-Host "建立 requirements.txt 檔案"
          @"
        selenium>=4.15.0
        pillow>=9.0.0
        "@ | Out-File -FilePath "requirements.txt" -Encoding utf8
        } else {
          Write-Host "requirements.txt 已存在"
          Get-Content requirements.txt
        }
    
    - name: Verify Python environment
      run: |
        python --version
        pip list | findstr selenium
        pip list | findstr pillow
    
    - name: Build executable
      run: |
        # 設定控制台編碼為 UTF-8
        $env:PYTHONIOENCODING = "utf-8"
        chcp 65001
        
        # 使用更詳細的 PyInstaller 配置
        pyinstaller --onefile --console --name="WebScreenshot" --add-data="chromedriver.exe;." --icon=NONE --distpath="dist" --workpath="build" --specpath="." --hidden-import=encodings --
